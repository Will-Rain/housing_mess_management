<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
	<meta charset="UTF-8">
	<title>更新居民信息</title>
	<link rel="stylesheet" th:href="@{/css/oksub.css}">
	<script type="text/javascript" th:src="@{/lib/loading/okLoading.js}"></script>
</head>
<body>
<div class="ok-body" shiro:hasPermission="1">
	<!--form表单-->
	<form class="layui-form ok-form" lay-filter="filter">

		<input type="hidden" id="residentId" name="residentId" class="layui-input">
		<input type="hidden" id="buildingId" name="buildingId" class="layui-input">
		<input type="hidden" id="unitId" name="unitId" class="layui-input">
		<input type="hidden" id="houseId" name="houseId" class="layui-input">

		<div class="layui-form-item" lay-filter="buildingNumber">
			<label class="layui-form-label">楼宇号</label>
			<div class="layui-input-block">
<!--				<input type="text" name="buildingNumber" readonly unselectable="on" placeholder="请输入单元号" autocomplete="off" class="layui-input" lay-verify="required">-->
				<select id="buildingNumber" name="buildingNumber" lay-filter="buildingNumber"
						lay-search lay-verify="required">
				</select>
			</div>

		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">单元号</label>
			<div class="layui-input-block">
<!--				<input type="text" name="unitNumber" readonly unselectable="on" placeholder="请输入单元号" -->
<!--					   autocomplete="off" class="layui-input" lay-verify="required">-->
				<select id="unitNumber" name="unitNumber" lay-filter="unitNumber"
						lay-search lay-verify="required">
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">房屋号</label>
			<div class="layui-input-block">
<!--				<input type="text" name="houseNumber" readonly unselectable="on" placeholder="请输入房屋号" -->
<!--					   autocomplete="off" class="layui-input" lay-verify="required">-->
				<select id="houseNumber" name="houseNumber" lay-filter="houseNumber"
						lay-search lay-verify="required">
				</select>
			</div>
		</div>

		<div class="layui-form-item">
			<label class="layui-form-label">姓名</label>
			<div class="layui-input-block">
				<input type="text" name="name" placeholder="请输入姓名" autocomplete="off" class="layui-input" lay-verify="required">
			</div>
		</div>

		<!--隐藏按钮 上传-->
		<button id="upload_img" type="button" hidden></button>
		<div class="layui-form-item">
			<label class="layui-form-label">照片</label>
			<div class="layui-input-inline">
				<!--				<input type="text" name="photo" placeholder="请输入" autocomplete="off" class="layui-input">-->
				<div class="layui-upload-drag" id="photo">
					<i class="layui-icon">&#xe67c;</i>
					<p>点击上传，或将文件拖拽到此处</p>
				</div>
			</div>
			<div class="layui-input-inline">
				<div class="layui-hide" id="uploadDemoView">
					<img src="" alt="上传成功后渲染" style="max-width: 196px">
				</div>
				<div id="show">
					<img src="" alt="旧头像预览" style="max-width: 196px">
				</div>
			</div>
		</div>


		<div class="layui-form-item">
			<label class="layui-form-label">性别</label>
			<div class="layui-input-block">
				<input type="radio" name="gender" value="男" title="男" checked="">
				<input type="radio" name="gender" value="女" title="女">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">生日</label>
			<div class="layui-input-block">
				<input type="text" name="birthday" placeholder="请选择生日" autocomplete="off" class="layui-input"
					   id="birthday">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">手机号码</label>
			<div class="layui-input-block">
				<input type="text" name="telephoneNumber" placeholder="请输入手机号码" autocomplete="off" class="layui-input"
					   lay-verify="required|phone">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">身份证号</label>
			<div class="layui-input-block">
				<input type="text" name="identityCard" placeholder="请输入身份证号" autocomplete="off" class="layui-input"
					   lay-verify="required">
			</div>
		</div>

		<div class="layui-form-item">
			<div class="layui-form-label">户籍所在地</div>
			<div class="layui-input-block">
				<input type="text" name="censusRegister" placeholder="请输入户籍所在地" autocomplete="off" class="layui-input"
					   lay-verify="required">
			</div>
		</div>


		<div class="layui-form-item">
			<label class="layui-form-label">教育程度</label>
			<div class="layui-input-block">
				<select id="educationalLevel" name="educationalLevel" lay-filter="educationalLevel" lay-search lay-verify="required">
					<option value="无">无</option>
					<option value="小学">小学</option>
					<option value="初中">初中</option>
					<option value="高中">高中</option>
					<option value="专科">专科</option>
					<option value="本科">本科</option>
					<option value="研究生">研究生</option>
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">所属党派</label>
			<div class="layui-input-block">
				<select id="party" name="party" lay-filter="party" lay-search lay-verify="required">
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">是否是户主</label>
			<div class="layui-input-block">
				<select id="isHeadOfHousehold" name="isHeadOfHousehold" lay-filter="isHeadOfHousehold" lay-search lay-verify="required">
					<option value="1">是</option>
					<option value="0" selected>否</option>
				</select>
			</div>
		</div>


		<div class="layui-form-item">
			<div class="layui-input-block">
				<button class="layui-btn" lay-submit lay-filter="edit">立即提交</button>
				<button type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>
</div>
<!--js逻辑-->
<script th:src="@{/lib/layui/layui.js}"></script>
<script>
	let initData;

	function formatDate(now) {
		var year=now.getFullYear();  //取得4位数的年份
		var month=now.getMonth()+1;  //取得日期中的月份，其中0表示1月，11表示12月
		var date=now.getDate();      //返回日期月份中的天数（1到31）
		return year+"-"+month+"-"+date;
	}


	function initForm(data) {
		let d=new Date(data.birthday);
		data.birthday = formatDate(d); //把时间戳格式化为日期
		// console.log(JSON.stringify(data));

		let resident = {

			buildingId: data.house.unit.building.id,
			buildingNumber: data.house.unit.building.buildingNumber,
			unitId: data.house.unit.id,
			unitNumber: data.house.unit.unitNumber,
			houseId: data.house.id,
			houseNumber: data.house.houseNumber,

			residentId: data.id,
			name: data.name,
			gender: data.gender,
			photo: data.photo,
			birthday: data.birthday,
			telephoneNumber: data.telephoneNumber,
			identityCard: data.identityCard,
			censusRegister: data.censusRegister,
			educationalLevel: data.educationalLevel,
			party: data.party.party,
			isHeadOfHousehold: data.isHeadOfHousehold,
		};

		initData = resident;
	}

	//配置插件目录
	layui.config({
		base: '/lib/layui/lay/okmodules/'  //layarea所在文件夹
	});
	layui.use(["element", "form", "laydate", "okLayer", "okUtils", "upload", "layarea"], function () {
		let form = layui.form;
		let laydate = layui.laydate;
		let okLayer = layui.okLayer;
		let okUtils = layui.okUtils;
		let $ = layui.$;
		let upload = layui.upload;
		let layarea = layui.layarea;
		okLoading.close();

		initForm(parent.editData);
		form.val("filter",initData);
		// 下拉框赋初值
		$("select[id='buildingNumber']").append("<option value="+ parent.editData.house.unit.building.buildingNumber +">"
				+ parent.editData.house.unit.building.buildingNumber +"号楼</option>");
		$("select[id='unitNumber']").append("<option value="+ parent.editData.house.unit.unitNumber +">"
				+ parent.editData.house.unit.unitNumber +"单元</option>");
		$("select[id='houseNumber']").append("<option value="+ parent.editData.house.houseNumber +">"
				+ parent.editData.house.houseNumber +"室</option>");
		$("select[id='party']").append("<option value="+ parent.editData.party.id +">"
				+ parent.editData.party.party +"</option>");

		form.render();


		form.verify({
			number: [/^[0-9]*$/,"该项必须是数字"],
			phone: [/^[1][0-9]{10}$/,"手机号格式不正确"],
		});

		//绑定日历
		laydate.render({elem: '#birthday', type: 'date',trigger: 'click'});

		//旧头像
		layui.$('#show').find('img').attr('src', '/residentPhoto/' + initData.photo);



		var buildingNumber = parent.editData.house.unit.building.buildingNumber,
				unitNumber = parent.editData.house.unit.unitNumber,
				houseNumber = parent.editData.house.houseNumber;

		function getBuildingNumber(){
			//获取下拉框buildingNumber
			okUtils.ajax("/building/selectDistinctNumber", "get",
					{}, false).done(function (response) {
				// console.log(response);
				let select = $("select[id='buildingNumber']");

				$.each(response, function (i, item) {
					if(parent.editData.house.unit.building.buildingNumber !== item) //防止重复
						select.append("<option value="+ item+">"+ item+"号楼</option>");

				});

				form.render('select');
			}).fail(function (error) {
				console.log(error)
			});
		}
		function getUnitNumber() {
				//填充unitNumber下拉框
			okUtils.ajax("/unit/selectDistinctUnitNumber", "get",
					{buildingId: parent.editData.house.unit.building.id}, false).done(function (response) {
				let select = $("select[id='unitNumber']");

				$.each(response, function (i, item) {
					if(parent.editData.house.unit.unitNumber !== item)
						select.append("<option value="+ item+">"+ item+"单元</option>");
				});
				form.render('select');
			}).fail(function (error) {
				console.log(error)
			});
		}
		function getHouseNumber() {
				//填充houseNumber下拉框
			okUtils.ajax("/house/selectDistinctHouseNumber", "get",
					{unitId: parent.editData.house.unit.id}, false).done(function (response) {
				// console.log(response);
				let select = $("select[id='houseNumber']");

				$.each(response, function (i, item) {
					if(parent.editData.house.houseNumber !== item)
						select.append("<option value="+ item+">"+ item+"室</option>");
				});
				form.render('select');
			}).fail(function (error) {
				console.log(error)
			});
		}
		function getParty(){  // 获取party
			okUtils.ajax("/party/selectDistinctParty", "get",
					{}, false).done(function (response) {
				// console.log(response);

				let select = $("select[id='party']");

				$.each(response, function (i, item) {
					if(parent.editData.party.id !== item.id)
						select.append("<option value="+ item.id +">"+ item.party+"</option>");
				});
				form.render('select');
			}).fail(function (error) {
				console.log(error)
			});
		}

		// 初始化加载下拉框的值
		layer.ready(function () {
			getBuildingNumber();
			getUnitNumber();
			getHouseNumber();
			getParty();
		});


		// 点击下拉框时重新获取其余下拉框的值
		form.on("select(buildingNumber)", function (data) {
			buildingNumber = data.value;

			$("select[id='houseNumber']").empty();
			//填充隐藏域buildingId
			if(data.value!=='' && data.value!=null){
				okUtils.ajax("/building/selectDistinctId", "get",
						{number:data.value}, false).done(function (response) {
					$("#buildingId").val(response);

					//填充unitNumber下拉框
					okUtils.ajax("/unit/selectDistinctUnitNumber", "get",
							{buildingId: response}, false).done(function (response) {
						// console.log(response.length);

						let select = $("select[id='unitNumber']");
						select.empty();
						$.each(response, function (i, item) {
							select.append("<option value="+ item+">"+ item+"单元</option>");
						});
						form.render('select');
					}).fail(function (error) {
						console.log(error)
					});

					form.render();

				}).fail(function (error) {
					console.log(error)
				});
			}

		});

		form.on("select(unitNumber)", function (data) {
			unitNumber = data.value;

			//填充unitId隐藏域
			if (data.value !== '' && data.value != null) {
				okUtils.ajax("/unit/selectDistinctUnitId", "get",
						{buildingNumber:buildingNumber, unitNumber: data.value}, false).done(function (response) {
					$("#unitId").val(response);
					// console.log("response = " + response);

					//填充houseNumber下拉框
					okUtils.ajax("/house/selectDistinctHouseNumber", "get",
							{unitId: response}, false).done(function (response) {
						// console.log(response);
						let select = $("select[id='houseNumber']");
						select.empty();
						select.html("");
						$.each(response, function (i, item) {
							select.append("<option value="+ item+">"+ item+"室</option>");
						});
						form.render('select');
					}).fail(function (error) {
						console.log(error)
					});

					form.render();
				}).fail(function (error) {
					console.log(error)
				});
			}
		});

		form.on("select(houseNumber)", function (data) {
			houseNumber = data.value;

			//填充unitId隐藏域
			if (data.value !== '' && data.value != null) {
				okUtils.ajax("/house/selectDistinctHouseId", "get",
						{buildingNumber:buildingNumber, unitNumber: unitNumber, houseNumber: data.value}, false).done(function (response) {
					$("#houseId").val(response);

					form.render();
				}).fail(function (error) {
					console.log(error)
				});
			}
		});





		//图片上传
		upload.render({
			elem: '#photo',
			url: '/resident/upload',
			data: {identityCard: function(){
					return $("input[name='identityCard']").val();
				}},
			auto: false,//不自动上传
			bindAction: '#upload_img',
			accept: 'images',
			size: 1024*10,
			drag: true, //可拖拽上传

			choose: function(obj){
				obj.preview(function(index, file, result){
					layui.$('#uploadDemoView').removeClass('layui-hide').find('img').attr('src', result);
					layui.$('#show').addClass('layui-hide');//隐藏旧头像
				});
			},
			done: function(res){
				// console.log(res);
			},
			error: function(){
				//请求异常回调
				parent.layer.msg("图片上传失败");
			}
		});



		form.on("submit(edit)", function (data) {
			// console.log("data.field.houseId = "+$("#houseId").val());
			let resident = {
				id: data.field.residentId,
				name: data.field.name,
				gender: data.field.gender,
				birthday: data.field.birthday,
				telephoneNumber: data.field.telephoneNumber,
				identityCard: data.field.identityCard,
				censusRegister: data.field.censusRegister,
				educationalLevel: data.field.educationalLevel,
				party: {
					id: data.field.party
				},
				isHeadOfHousehold: data.field.isHeadOfHousehold,
				house: {
					id: data.field.houseId,
					unit: {
						id: data.field.unitId,
						building: {
							id: data.field.buildingId
						}
					}
				}

			};


			$.ajax({
				url: "/resident/updateResident",
				type:"put",
				data: JSON.stringify(resident),
				contentType: "application/json",
				success:function (response) {
					// console.log(response);
					if(response === 1) {
						okLayer.greenTickMsg("修改成功", function () {
							// console.log("identity = " + $("input[name='identityCard']").val());

							//用于判断修改图片：是否上传了新图片
							if($('#uploadDemoView img').attr('src') !== '' && $('#uploadDemoView img').attr('src') != null)
							{
								$('#upload_img').click(); //上传成功后单击隐藏的提交按钮
							}
							parent.layer.close(parent.layer.getFrameIndex(window.name));
						});
					}
					else if(response === 0){
						okLayer.yellowSighMsg("修改失败",function () {
							parent.layer.close(parent.layer.getFrameIndex(window.name));
						});
					}
					else if(response === 2){
						okLayer.yellowSighMsg("此操作导致原住房中不存在户主，请先确保原住房中仅有户主一人",function () {
							parent.layer.close(parent.layer.getFrameIndex(window.name));
						});
					}
					else if(response === 3){
						okLayer.yellowSighMsg("新住房已存在户主，请先更改该居民户主信息",function () {
							parent.layer.close(parent.layer.getFrameIndex(window.name));
						});
					}
					else if(response === 4){
						okLayer.yellowSighMsg("住房中不存在户主，请先指定户主",function () {
							parent.layer.close(parent.layer.getFrameIndex(window.name));
						});
					}


				},
				error:function () {
					console.log("error");
				}
			});

			return false;
		});
	})
</script>
</body>
</html>
